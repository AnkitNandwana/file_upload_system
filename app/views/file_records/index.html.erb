<div class="container mt-4">
  <!-- Top Navigation Bar -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>My Files</h1>
    <div class="d-flex align-items-center gap-3">
      <% if user_signed_in? %>
        <%= link_to 'Upload File', new_file_record_path, class: 'btn btn-primary btn-sm' %>
        <span class="text-muted">Logged in as: <strong><%= current_user.email %></strong></span>
        <%= button_to "Logout", destroy_user_session_path, 
                      method: :delete, 
                      class: 'btn btn-outline-danger btn-sm' %>
      <% else %>
        <%= link_to "Login", new_user_session_path, class: 'btn btn-primary btn-sm' %>
      <% end %>
    </div>
  </div>

  <% if @file_records.any? %>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>Title</th>
            <th>File</th>
            <th>Size</th>
            <th>Uploaded</th>
            <th>Share Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @file_records.each do |file_record| %>
            <tr>
              <td>
                <%= link_to file_record.title, file_record, class: 'text-decoration-none' %>
                <% if file_record.description.present? %>
                  <small class="text-muted d-block"><%= truncate(file_record.description, length: 40) %></small>
                <% end %>
              </td>
              <td>
                <%= file_record.file.filename %>
                <small class="text-muted d-block"><%= file_record.file.content_type %></small>
              </td>
              <td><%= number_to_human_size(file_record.file.byte_size) %></td>
              <td><%= time_ago_in_words(file_record.created_at) %> ago</td>
              <td>
                <% if file_record.shared_link %>
                  <span class="badge bg-success">Shared</span>
                  <small class="d-block text-muted">
                    <% if file_record.shared_link.expires_at %>
                      Expires in <%= distance_of_time_in_words(Time.current, file_record.shared_link.expires_at) %>
                    <% else %>
                      Never expires
                    <% end %>
                  </small>
                <% else %>
                  <span class="badge bg-secondary">Private</span>
                <% end %>
              </td>
              <td>
                <div class="d-flex gap-2">
                  <!-- View Button -->
                  <%= link_to file_record, class: 'btn btn-sm btn-outline-primary' do %>
                    <i class="bi bi-eye"></i>
                  <% end %>

                  <!-- Share Button -->
                  <% if file_record.shared_link %>
                    <%= button_to share_file_record_path(file_record), 
                                method: :post,
                                class: 'btn btn-sm btn-outline-success',
                                title: 'Copy share link',
                                data: { toggle: 'tooltip', placement: 'top' } do %>
                      <i class="bi bi-link-45deg"></i>
                    <% end %>
                  <% else %>
                    <%= button_to share_file_record_path(file_record), 
                                method: :post,
                                class: 'btn btn-sm btn-outline-secondary',
                                title: 'Generate share link' do %>
                      <i class="bi bi-share"></i>
                    <% end %>
                  <% end %>

                  <!-- Download Button -->
                  <%= link_to rails_blob_path(file_record.file, disposition: 'attachment'), 
                            class: 'btn btn-sm btn-outline-info',
                            title: 'Download' do %>
                    <i class="bi bi-download"></i>
                  <% end %>

                  <!-- Delete Button -->
                  <%= button_to file_record, 
                              method: :delete,
                              class: 'btn btn-sm btn-outline-danger',
                              data: { confirm: 'Are you sure?' },
                              title: 'Delete' do %>
                    <i class="bi bi-trash"></i>
                  <% end %>
                </div>

                <% if file_record.shared_link && file_record.shared_link.slug %>
                  <div class="mt-2">
                    <small class="text-muted">
                      <%= link_to 'Copy link', '#', 
                                  class: 'copy-link',
                                  data: { link: shared_file_url(file_record.shared_link.slug) } %>
                    </small>
                  </div>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="alert alert-info">
      <p>You haven't uploaded any files yet.</p>
      <%= link_to 'Upload your first file', new_file_record_path, class: 'btn btn-primary' %>
    </div>
  <% end %>
</div>

<!-- JavaScript for copy functionality -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Copy link functionality
    document.querySelectorAll('.copy-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault()
        const url = this.getAttribute('data-link')
        navigator.clipboard.writeText(url)
          .then(() => {
            const originalText = this.textContent
            this.textContent = 'Copied!'
            setTimeout(() => {
              this.textContent = originalText
            }, 2000)
          })
      })
    })
  })
</script>

<!-- Add Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">